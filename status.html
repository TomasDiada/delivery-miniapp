document.getElementById('check-status').onclick = async function() {
    const orderId = document.getElementById('order-id').value.trim();
    if (!orderId) {
        alert('Пожалуйста, введите номер заказа');
        return;
    }
    
    const button = this;
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span> Загрузка...';
    
    try {
        const response = await fetch(`https://2d6a-5-35-38-182.ngrok-free.app/api/status/${orderId}?_=${Date.now()}`);
        
        // Проверяем, что ответ JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('Сервер вернул не-JSON ответ');
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Ошибка сервера');
        }
        
        displayOrderStatus(data);
        document.getElementById('status-result').style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        alert('Ошибка при проверке статуса: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = 'Проверить';
    }
};

function displayOrderStatus(data) {
    // Обновляем основную информацию
    document.getElementById('order-number').textContent = data.order_id;
    document.getElementById('order-date').textContent = data.history[0]?.timestamp || '—';
    
    // Обновляем статус
    const statusDisplay = document.getElementById('status-display');
    statusDisplay.textContent = data.status_label || data.status;
    
    // Нормализуем статус для класса CSS
    const statusClass = (data.status || 'new').toLowerCase().replace(/\s+/g, '_');
    statusDisplay.className = 'status-display status-' + statusClass;
    
    // Обновляем историю
    const historyContainer = document.getElementById('status-history');
    historyContainer.innerHTML = '';
    
    if (data.history && data.history.length > 0) {
        data.history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-status">${item.status || '—'}</div>
                <div class="history-user">Изменено: ${item.user || 'Система'}</div>
                <div class="history-time">${item.timestamp || '—'}</div>
            `;
            historyContainer.appendChild(historyItem);
        });
    } else {
        historyContainer.innerHTML = '<p>История статусов отсутствует</p>';
    }
}