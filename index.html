<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #a50064;
      --primary-hover: #8c0056;
      --secondary-color: #f8f2f9;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --border-radius: 12px;
      --box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    * {
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--secondary-color);
      margin: 0;
      padding: 20px;
      color: var(--text-color);
      line-height: 1.5;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .card {
      background: #ffffff;
      padding: 25px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }
    
    input[type="tel"],
    input[type="text"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
      background-color: var(--light-gray);
    }
    
    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 8px rgba(165, 0, 100, 0.25);
    }
    
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 12px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .radio-option input {
      width: auto;
      margin: 0;
    }
    
    button {
      width: 100%;
      background-color: var(--primary-color);
      border: none;
      color: white;
      font-size: 18px;
      padding: 14px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .secondary-btn {
      background-color: #6c757d;
    }
    
    .secondary-btn:hover {
      background-color: #5a6268;
    }
    
    #location-status {
      font-style: italic;
      margin: 10px 0 15px 0;
      color: #555;
      min-height: 20px;
    }
    
    #photo-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: none;
      object-fit: contain;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .success-message {
      color: #388e3c;
      text-align: center;
      margin: 20px 0;
      font-weight: 500;
      display: none;
    }
    
    .status-container {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    
    .status-header {
      margin-bottom: 20px;
    }
    
    .order-id {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 10px 0;
      color: var(--primary-color);
    }
    
    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin: 15px 0;
      font-size: 1.1rem;
    }
    
    .status-new { background: #ff9800; color: white; }
    .status-accepted { background: #2196f3; color: white; }
    .status-in_progress { background: #9c27b0; color: white; }
    .status-completed { background: #4caf50; color: white; }
    .status-rejected { background: #f44336; color: white; }
    
    .status-timeline {
      position: relative;
      padding: 20px 0;
      margin: 20px 0;
    }
    
    .timeline-line {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #e0e0e0;
      transform: translateX(-50%);
      z-index: 1;
    }
    
    .status-step {
      position: relative;
      margin-bottom: 40px;
      z-index: 2;
    }
    
    .step-content {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 80%;
      margin: 0 auto;
    }
    
    .step-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .step-time {
      font-size: 0.9rem;
      color: #666;
    }
    
    .active-step .step-content {
      border: 2px solid var(--primary-color);
    }
    
    .completed-step .step-content {
      background: #e8f5e9;
    }
    
    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
    }
    
    .completed-step .step-icon {
      background: #4caf50;
      color: white;
    }
    
    .active-step .step-icon {
      background: var(--primary-color);
      color: white;
    }
    
    .qr-code {
      max-width: 200px;
      margin: 20px auto;
      display: block;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="order-form-section">
      <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
      
      <div class="card">
        <form id="order-form" autocomplete="off">
          <div class="form-group">
            <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="+7XXXXXXXXXX"
              pattern="^\+7\d{10}$"
              required
              title="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX"
            />
            <div id="phone-error" class="error-message">–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
          </div>
          
          <div class="form-group">
            <label>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="delivery_type" value="–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (150‚ÇΩ)" checked />
                <span>–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Äî 150‚ÇΩ</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="delivery_type" value="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–∞ –∫—É—Ä—å–µ—Ä–æ–º (200‚ÇΩ)" />
                <span>–ö—É—Ä—å–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–≤–∞—Ä ‚Äî 200‚ÇΩ</span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label for="photo">QR –∫–æ–¥ –∑–∞–∫–∞–∑–∞:</label>
            <input type="file" id="photo" name="photo" accept="image/*" required />
            <div id="photo-error" class="error-message">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ QR –∫–æ–¥–∞</div>
            <img id="photo-preview" alt="–ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ" />
          </div>
          
          <button type="button" id="get-location">
            <span id="location-icon">üìç</span> –ü–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é
          </button>
          <p id="location-status"></p>
          
          <div class="form-group">
            <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞):</label>
            <input
              type="text"
              id="address"
              name="address"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é"
            />
            <div id="address-error" class="error-message">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é</div>
          </div>
          
          <input type="hidden" id="latitude" name="latitude" />
          <input type="hidden" id="longitude" name="longitude" />
          <input type="hidden" id="chat_id" name="chat_id" />
          
          <button type="submit" id="submit-btn">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
          </button>
          
          <div id="success-message" class="success-message">
            –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! ‚úÖ
          </div>
        </form>
      </div>
    </div>
    
    <div id="status-section" class="status-container">
      <div class="card">
        <div class="status-header">
          <h2>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h2>
          <div class="order-id">–ó–∞–∫–∞–∑ #<span id="status-order-id">---</span></div>
          <div id="status-badge" class="status-badge status-new">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
        </div>
        
        <div class="status-timeline">
          <div class="timeline-line"></div>
          
          <div class="status-step completed-step" id="step-ordered">
            <div class="step-icon">1</div>
            <div class="step-content">
              <div class="step-title">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω</div>
              <div class="step-time" id="time-ordered">-</div>
            </div>
          </div>
          
          <div class="status-step" id="step-accepted">
            <div class="step-icon">2</div>
            <div class="step-content">
              <div class="step-title">–ü—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É</div>
              <div class="step-time" id="time-accepted">-</div>
            </div>
          </div>
          
          <div class="status-step" id="step-in-progress">
            <div class="step-icon">3</div>
            <div class="step-content">
              <div class="step-title">–ö—É—Ä—å–µ—Ä –≤ –ø—É—Ç–∏</div>
              <div class="step-time" id="time-in-progress">-</div>
            </div>
          </div>
          
          <div class="status-step" id="step-completed">
            <div class="step-icon">4</div>
            <div class="step-content">
              <div class="step-title">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</div>
              <div class="step-time" id="time-completed">-</div>
            </div>
          </div>
        </div>
        
        <img id="qr-code" class="qr-code" alt="QR-–∫–æ–¥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è" />
        <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç–∞—Ç—É—Å—É –∑–∞–∫–∞–∑–∞</p>
        
        <button type="button" id="new-order-btn" class="secondary-btn">
          üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
        </button>
      </div>
    </div>
  </div>

<script>
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
  const tgWebApp = window.Telegram.WebApp;
  tgWebApp.expand();
  tgWebApp.enableClosingConfirmation();
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = tgWebApp.initDataUnsafe.user || {};
  document.getElementById('chat_id').value = user.id || '';
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
  const app = {
    orderFormSection: document.getElementById('order-form-section'),
    statusSection: document.getElementById('status-section'),
    form: document.getElementById('order-form'),
    phoneInput: document.getElementById('phone'),
    photoInput: document.getElementById('photo'),
    photoPreview: document.getElementById('photo-preview'),
    locationBtn: document.getElementById('get-location'),
    locationStatus: document.getElementById('location-status'),
    latitudeInput: document.getElementById('latitude'),
    longitudeInput: document.getElementById('longitude'),
    addressInput: document.getElementById('address'),
    submitBtn: document.getElementById('submit-btn'),
    phoneError: document.getElementById('phone-error'),
    photoError: document.getElementById('photo-error'),
    addressError: document.getElementById('address-error'),
    successMessage: document.getElementById('success-message'),
    statusOrderId: document.getElementById('status-order-id'),
    statusBadge: document.getElementById('status-badge'),
    newOrderBtn: document.getElementById('new-order-btn'),
    qrCode: document.getElementById('qr-code'),
    timeOrdered: document.getElementById('time-ordered'),
    timeAccepted: document.getElementById('time-accepted'),
    timeInProgress: document.getElementById('time-in-progress'),
    timeCompleted: document.getElementById('time-completed'),
    stepOrdered: document.getElementById('step-ordered'),
    stepAccepted: document.getElementById('step-accepted'),
    stepInProgress: document.getElementById('step-in-progress'),
    stepCompleted: document.getElementById('step-completed')
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order_id');
  
  if (orderId) {
    showOrderStatus(orderId);
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
  async function showOrderStatus(orderId) {
    app.orderFormSection.classList.add('hidden');
    app.statusSection.style.display = 'block';
    
    app.statusOrderId.textContent = orderId;
    app.statusBadge.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    app.statusBadge.className = 'status-badge status-new';
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ QR-–∫–æ–¥–∞
    app.qrCode.src = `https://5ba0-5-35-38-182.ngrok-free.app/api/qrcode/${orderId}`;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    await updateOrderStatus(orderId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(() => updateOrderStatus(orderId), 30000);
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
  async function updateOrderStatus(orderId) {
    try {
      const response = await fetch(`https://5ba0-5-35-38-182.ngrok-free.app/api/order/${orderId}/status`);
      
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞');
      }
      
      const statusData = await response.json();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      const status = statusData.status || 'new';
      app.statusBadge.textContent = statusData.client_status || '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
      app.statusBadge.className = `status-badge status-${status}`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
      const now = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
      app.stepOrdered.classList.remove('active-step');
      app.stepAccepted.classList.remove('active-step', 'completed-step');
      app.stepInProgress.classList.remove('active-step', 'completed-step');
      app.stepCompleted.classList.remove('active-step', 'completed-step');
      
      // –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω
      app.stepOrdered.classList.add('completed-step');
      app.timeOrdered.textContent = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
      if (status === 'accepted' || status === 'in_progress' || status === 'completed') {
        app.stepAccepted.classList.add('completed-step');
        app.timeAccepted.textContent = now;
      }
      
      if (status === 'in_progress' || status === 'completed') {
        app.stepInProgress.classList.add('completed-step');
        app.timeInProgress.textContent = now;
      }
      
      if (status === 'completed') {
        app.stepCompleted.classList.add('completed-step');
        app.timeCompleted.textContent = now;
      }
      
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      if (status === 'accepted') {
        app.stepAccepted.classList.add('active-step');
      } else if (status === 'in_progress') {
        app.stepInProgress.classList.add('active-step');
      } else if (status === 'completed') {
        app.stepCompleted.classList.add('active-step');
      }
      
    } catch (error) {
      console.error('Status update error:', error);
      app.statusBadge.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞';
    }
  }
  
  // –ö–Ω–æ–ø–∫–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
  app.newOrderBtn.addEventListener('click', () => {
    app.statusSection.style.display = 'none';
    app.orderFormSection.classList.remove('hidden');
    window.history.replaceState({}, document.title, window.location.pathname);
  });
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
  function validateForm() {
    let isValid = true;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (!/^\+7\d{10}$/.test(app.phoneInput.value.trim())) {
      app.phoneError.style.display = 'block';
      isValid = false;
    } else {
      app.phoneError.style.display = 'none';
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ç–æ
    if (!app.photoInput.files.length) {
      app.photoError.style.display = 'block';
      isValid = false;
    } else {
      app.photoError.style.display = 'none';
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞/–≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏
    if ((!app.latitudeInput.value || !app.longitudeInput.value) && !app.addressInput.value.trim()) {
      app.addressError.style.display = 'block';
      isValid = false;
    } else {
      app.addressError.style.display = 'none';
    }
    
    return isValid;
  }
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
  app.locationBtn.onclick = () => {
    if (!navigator.geolocation) {
      app.locationStatus.textContent = '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º';
      return;
    }
    
    app.locationStatus.textContent = '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...';
    app.locationBtn.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
      position => {
        app.locationStatus.textContent = '–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞';
        app.latitudeInput.value = position.coords.latitude;
        app.longitudeInput.value = position.coords.longitude;
        app.addressInput.value = '';
        app.addressError.style.display = 'none';
        app.locationBtn.disabled = false;
      },
      error => {
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
            break;
          case error.TIMEOUT:
            errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
            break;
        }
        app.locationStatus.textContent = errorMessage;
        app.locationBtn.disabled = false;
      },
      { 
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  };
  
  // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ
  app.photoInput.addEventListener('change', () => {
    const file = app.photoInput.files[0];
    if (file) {
      if (!file.type.match('image.*')) {
        app.photoError.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        app.photoError.style.display = 'block';
        app.photoInput.value = '';
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        app.photoError.textContent = '–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB';
        app.photoError.style.display = 'block';
        app.photoInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = e => {
        app.photoPreview.src = e.target.result;
        app.photoPreview.style.display = 'block';
        app.photoError.style.display = 'none';
      };
      reader.readAsDataURL(file);
    } else {
      app.photoPreview.style.display = 'none';
      app.photoPreview.src = '';
    }
  });
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
  app.form.onsubmit = async function(e) {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    app.submitBtn.disabled = true;
    app.submitBtn.innerHTML = '<span class="loading"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    const formData = new FormData();
    formData.append('phone', app.phoneInput.value.trim());
    formData.append('photo', app.photoInput.files[0]);
    formData.append('delivery_type', 
      document.querySelector('input[name="delivery_type"]:checked').value);
    formData.append('chat_id', app.chat_id.value);
    
    if (app.latitudeInput.value && app.longitudeInput.value) {
      formData.append('latitude', app.latitudeInput.value);
      formData.append('longitude', app.longitudeInput.value);
    } else {
      formData.append('address', app.addressInput.value.trim());
    }
    
    try {
      const response = await fetch('https://5ba0-5-35-38-182.ngrok-free.app/api/order', {
        method: 'POST',
        body: formData,
      });
      
      if (response.ok) {
        const data = await response.json();
        app.successMessage.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        showOrderStatus(data.order_id);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º URL
        window.history.replaceState({}, document.title, `?order_id=${data.order_id}`);
      } else {
        const error = await response.text();
        throw new Error(error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      }
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞: ' + error.message);
    } finally {
      app.submitBtn.disabled = false;
      app.submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
    }
  };
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  app.phoneInput.addEventListener('input', () => {
    if (/^\+7\d{0,10}$/.test(app.phoneInput.value)) {
      app.phoneError.style.display = 'none';
    }
  });
  
  app.addressInput.addEventListener('input', () => {
    if (app.addressInput.value.trim()) {
      app.addressError.style.display = 'none';
    }
  });
</script>
</body>
</html>