<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Заказ доставки</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style> 
  :root {
    --primary-color: #d4af37;         /* золотой */
    --primary-hover: #b68c28;         /* тёмно-золотой */
    --background-color: #0e0e0e;      /* почти чёрный */
    --form-bg: #1b1b1b;               /* тёмно-серый */
    --text-color: #f5f5f5;            /* светлый текст */
    --input-bg: #2b2b2b;
    --input-border: #555;
    --border-radius: 12px;
    --box-shadow: 0 4px 16px rgba(255, 215, 0, 0.1);
  }

  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--background-color);
    margin: 0;
    padding: 20px;
    color: var(--text-color);
    line-height: 1.5;
  }

  h2 {
    text-align: center;
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  form {
    max-width: 420px;
    margin: 0 auto;
    background: var(--form-bg);
    padding: 25px 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
  }

  /* ... (остальные стили остаются без изменений) ... */
</style>
</head>

<body>
  <div id="app">
    <div class="logo-wrapper">
      <img src="data:image/png;base64," alt="Логотип" class="logo-image" />
    </div>

    <h2>Оформление заказа доставки</h2>
    
    <form id="order-form" autocomplete="off">
      <!-- ... (остальные поля формы без изменений) ... -->
    </form>
  </div>

<script>
  // Инициализация Telegram WebApp
  const tgWebApp = window.Telegram.WebApp;
  tgWebApp.expand();
  tgWebApp.enableClosingConfirmation();

  // Отладочная информация
  console.log('Telegram WebApp initData:', tgWebApp.initData);
  console.log('Telegram User ID:', tgWebApp.initDataUnsafe?.user?.id);
  
  // Проверка наличия user.id
  if (!tgWebApp.initDataUnsafe?.user?.id) {
    console.error('User ID not available in initDataUnsafe');
    alert('Ошибка: не удалось получить ID пользователя. Закройте Mini App и попробуйте снова.');
  }

  // Элементы DOM
  const app = {
    form: document.getElementById('order-form'),
    phoneInput: document.getElementById('phone'),
    photoInput: document.getElementById('photo'),
    photoPreview: document.getElementById('photo-preview'),
    locationBtn: document.getElementById('get-location'),
    locationStatus: document.getElementById('location-status'),
    latitudeInput: document.getElementById('latitude'),
    longitudeInput: document.getElementById('longitude'),
    addressInput: document.getElementById('address'),
    submitBtn: document.getElementById('submit-btn'),
    phoneError: document.getElementById('phone-error'),
    photoError: document.getElementById('photo-error'),
    addressError: document.getElementById('address-error'),
    successMessage: document.getElementById('success-message')
  };
  
  // ... (остальные функции без изменений до app.form.onsubmit) ...

  // Отправка формы
  app.form.onsubmit = async function(e) {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    app.submitBtn.disabled = true;
    app.submitBtn.innerHTML = '<span class="loading"></span> Отправка...';
    
    const formData = new FormData();
    formData.append('comment', document.getElementById('comment').value);
    formData.append('phone', app.phoneInput.value.trim());
    formData.append('photo', app.photoInput.files[0]);
    
    // Важное исправление: передаем только реальный chat_id или ничего
    if (tgWebApp.initDataUnsafe?.user?.id) {
      formData.append('telegram_chat_id', tgWebApp.initDataUnsafe.user.id);
      console.log('Sending with chat_id:', tgWebApp.initDataUnsafe.user.id);
    } else {
      console.error('No chat_id available, notifications will not be sent');
    }
    
    formData.append('delivery_type', 
      document.querySelector('input[name="delivery_type"]:checked').value);
    
    if (app.latitudeInput.value && app.longitudeInput.value) {
      formData.append('latitude', app.latitudeInput.value);
      formData.append('longitude', app.longitudeInput.value);
    } else {
      formData.append('address', app.addressInput.value.trim());
    }
    
    try {
      const response = await fetch('https://c915-5-35-38-182.ngrok-free.app/api/order', {
        method: 'POST',
        body: formData,
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('Order created with ID:', result.order_id);
        
        app.successMessage.style.display = 'block';
        app.form.reset();
        app.photoPreview.style.display = 'none';
        app.latitudeInput.value = '';
        app.longitudeInput.value = '';
        app.locationStatus.textContent = '';
        
        // Закрываем Mini App через 2 секунды
        setTimeout(() => {
          tgWebApp.close();
        }, 2000);
      } else {
        const error = await response.text();
        throw new Error(error || 'Ошибка сервера');
      }
    } catch (error) {
      console.error('Order submission error:', error);
      alert('Ошибка при отправке заказа: ' + error.message);
    } finally {
      app.submitBtn.disabled = false;
      app.submitBtn.textContent = 'Отправить заказ';
    }
  };

  // ... (остальной код без изменений) ...
</script>
</body>
</html>