<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ó–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–∫–∏</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    /* ... (–≤–µ—Å—å —Å—Ç–∏–ª—å –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å) ... */

    .map-container {
      height: 300px;
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
      display: none;
    }

    .geo-mode {
      margin: 15px 0 5px;
      font-weight: 600;
    }

    .geo-options label {
      display: inline-block;
      margin-right: 20px;
      font-weight: normal;
    }

    #get-current-location {
      margin-top: 10px;
      padding: 10px 12px;
      background-color: #28a745;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>

<form id="order-form">
  <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
  <input type="tel" id="phone" name="phone" placeholder="+7XXXXXXXXXX" pattern="^\+7\d{10}$" required />

  <label>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
  <div class="delivery-options">
    <button type="button" class="delivery-btn selected" data-value="–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (150‚ÇΩ)">–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Äî 150‚ÇΩ</button>
    <button type="button" class="delivery-btn" data-value="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–∞ –∫—É—Ä—å–µ—Ä–æ–º (200‚ÇΩ)">–ö—É—Ä—å–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–≤–∞—Ä ‚Äî 200‚ÇΩ</button>
  </div>
  <input type="hidden" name="delivery_type" id="delivery_type" value="–û–±—ã—á–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ (150‚ÇΩ)" />

  <label for="photo">–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞:</label>
  <input type="file" id="photo" name="photo" accept="image/*" required />
  <img id="photo-preview" alt="–§–æ—Ç–æ –ø—Ä–µ–≤—å—é" />

  <p class="geo-mode">–°–ø–æ—Å–æ–± —É–∫–∞–∑–∞–Ω–∏—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏:</p>
  <div class="geo-options">
    <label><input type="radio" name="geo_mode" value="current" checked /> –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</label>
    <label><input type="radio" name="geo_mode" value="manual" /> –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</label>
  </div>

  <button type="button" id="get-current-location">üìç –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é</button>
  <div id="location-status"></div>

  <div class="map-container" id="map"></div>

  <input type="hidden" id="latitude" name="latitude" />
  <input type="hidden" id="longitude" name="longitude" />

  <button type="submit">üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
</form>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // –°–º–µ–Ω–∞ —Å–ø–æ—Å–æ–±–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
  const mapContainer = document.getElementById('map');
  const getLocationBtn = document.getElementById('get-current-location');
  const locationStatus = document.getElementById('location-status');
  const latitudeInput = document.getElementById('latitude');
  const longitudeInput = document.getElementById('longitude');

  let map, marker;

  document.querySelectorAll('input[name="geo_mode"]').forEach(radio => {
    radio.addEventListener('change', e => {
      const mode = e.target.value;
      if (mode === 'current') {
        mapContainer.style.display = 'none';
        getLocationBtn.style.display = 'block';
        latitudeInput.value = '';
        longitudeInput.value = '';
        locationStatus.textContent = '';
      } else {
        getLocationBtn.style.display = 'none';
        mapContainer.style.display = 'block';
        initMap();
      }
    });
  });

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏
  getLocationBtn.onclick = () => {
    locationStatus.textContent = '–ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã...';
    navigator.geolocation.getCurrentPosition(
      pos => {
        latitudeInput.value = pos.coords.latitude;
        longitudeInput.value = pos.coords.longitude;
        locationStatus.textContent = '–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ ‚úÖ';
      },
      () => {
        locationStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚ùå';
      },
      { timeout: 10000 }
    );
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏ –≤—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤—Ä—É—á–Ω—É—é
  function initMap() {
    if (!map) {
      map = L.map('map').setView([55.75, 37.61], 10); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      map.on('click', e => {
        const { lat, lng } = e.latlng;
        latitudeInput.value = lat.toFixed(6);
        longitudeInput.value = lng.toFixed(6);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        locationStatus.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      });
    }
  }

  // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
  const deliveryButtons = document.querySelectorAll('.delivery-btn');
  const deliveryTypeInput = document.getElementById('delivery_type');

  deliveryButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      deliveryButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      deliveryTypeInput.value = btn.dataset.value;
    });
  });

  // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const photoInput = document.getElementById('photo');
  const photoPreview = document.getElementById('photo-preview');

  photoInput.addEventListener('change', () => {
    const file = photoInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        photoPreview.src = e.target.result;
        photoPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      photoPreview.style.display = 'none';
    }
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
  document.getElementById('order-form').onsubmit = async function (e) {
    e.preventDefault();

    const phone = document.getElementById('phone').value.trim();
    const photo = photoInput.files[0];
    const lat = latitudeInput.value;
    const lon = longitudeInput.value;
    const delivery = deliveryTypeInput.value;

    if (!/^\+7\d{10}$/.test(phone)) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX');
      return;
    }

    if (!photo || !lat || !lon) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ —É–∫–∞–∂–∏—Ç–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é');
      return;
    }

    const formData = new FormData();
    formData.append('phone', phone);
    formData.append('photo', photo);
    formData.append('latitude', lat);
    formData.append('longitude', lon);
    formData.append('delivery_type', delivery);

    try {
      const response = await fetch('https://13ba-5-35-38-182.ngrok-free.app/api/order', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        alert('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        this.reset();
        photoPreview.style.display = 'none';
        locationStatus.textContent = '';
        if (marker) map.removeLayer(marker);
        deliveryButtons[0].click(); // —Å–±—Ä–æ—Å
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.');
      }
    } catch (err) {
      alert('–û—à–∏–±–∫–∞: ' + err.message);
    }
  };
</script>

</body>
</html>
